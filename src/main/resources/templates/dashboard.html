<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>Dashboard</title>
</head>

<body>
    <div layout:fragment="content">

        <!-- Top Bar / Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-800" th:text="${currentCollection.name}">Collection Name</h2>
                <p class="text-gray-600" th:text="${currentCollection.description}">Description</p>
            </div>

            <!-- Quick Actions / Status -->
            <div class="flex items-center space-x-4">
                <!-- Delete Collection Button -->
                <form th:action="@{/collections/{id}(id=${currentCollection.id})}" th:method="delete"
                    onsubmit="return confirm('Are you sure you want to delete this collection?');">
                    <button type="submit" class="text-red-500 hover:text-red-700 font-medium">
                        <i class="fas fa-trash"></i> Delete Collection
                    </button>
                </form>
            </div>
        </div>

        <!-- Collection Settings (Fallback URL) -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-indigo-500">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Settings</h3>
            <form th:action="@{/collections/{id}(id=${currentCollection.id})}" method="post"
                th:object="${collectionForm}" class="flex items-end gap-4">
                <!-- Hidden fields for name/desc if we want to keep them, or we could make them editable too. 
                 For now, we just update the same object, so we should ideally include all fields or update logic to only patch what's present.
                 The controller updates name, desc, fallback. Let's include them as hidden or editable.
            -->
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                    <input type="text" th:field="*{name}"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <input type="text" th:field="*{description}"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex-[2]">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Fallback URL (Target Host)</label>
                    <input type="text" th:field="*{fallbackUrl}" placeholder="http://localhost:8081"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline font-mono">
                </div>
                <!-- Display global errors if any -->
                <div th:if="${#fields.hasAnyErrors()}" class="text-red-500 text-xs italic">
                    <ul>
                        <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
                    </ul>
                </div>
                <button type="submit"
                    class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Save
                </button>
            </form>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-4 border-b border-gray-200" x-data="{ tab: 'routes' }">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab"
                data-tabs-toggle="#myTabContent" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                        id="routes-tab" data-tabs-target="#routes" type="button" role="tab" aria-controls="routes"
                        aria-selected="false" onclick="showTab('routes')"
                        :class="activeTab === 'routes' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'">
                        <i class="fas fa-route mr-2"></i> Proxy Routes
                    </button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                        id="mocks-tab" data-tabs-target="#mocks" type="button" role="tab" aria-controls="mocks"
                        aria-selected="false" onclick="showTab('mocks')"
                        :class="activeTab === 'mocks' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'">
                        <i class="fas fa-mask mr-2"></i> Mock Configs
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <!-- Simple JS to toggle tabs since not using flowbite fully, just manual toggle for simplicity -->
        <script th:inline="javascript">
            function showTab(tabName) {
                const routesContent = document.getElementById('routes-content');
                const mocksContent = document.getElementById('mocks-content');
                if (!routesContent || !mocksContent) return;

                routesContent.classList.add('hidden');
                mocksContent.classList.add('hidden');

                document.getElementById(tabName + '-content').classList.remove('hidden');

                // Updating active classes on buttons manually or via a small helper
                document.getElementById('routes-tab').classList.remove('border-indigo-600', 'text-indigo-600');
                document.getElementById('mocks-tab').classList.remove('border-indigo-600', 'text-indigo-600');

                document.getElementById(tabName + '-tab').classList.add('border-indigo-600', 'text-indigo-600');
            }

            // Init
            document.addEventListener("DOMContentLoaded", function () {
                var activeTab = [[${activeTab}]];
                showTab(activeTab || 'routes');
            });

            // Re-init on HTMX swap to ensure correct tab is shown if full content was replaced
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target.id === 'myTabContent') {
                    // Extract active tab from the URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const activeTab = urlParams.get('tab') || 'routes';
                    showTab(activeTab);
                }
            });
        </script>

        <div id="myTabContent">
            <!-- Routes Tab -->
            <div th:classappend="${activeTab == 'routes'} ? '' : 'hidden'"
                 class="p-4 rounded-lg bg-white shadow-md" id="routes-content" role="tabpanel"
                aria-labelledby="routes-tab">
                <div th:replace="~{fragments/route-list :: route-list}"></div>
            </div>

            <!-- Mocks Tab -->
            <div th:classappend="${activeTab == 'mocks'} ? '' : 'hidden'"
                 class="p-4 rounded-lg bg-white shadow-md" id="mocks-content" role="tabpanel"
                aria-labelledby="mocks-tab">
                <div th:replace="~{fragments/mock-list :: mock-list}"></div>
            </div>
        </div>

    </div>
</body>

</html>